name: Open a PR that prepares the policy for release

on:
  workflow_call:
    secrets:
      APP_ID:
        description: "GitHub App ID used to generate a token for the repository dispatch"
        required: true
      APP_PRIVATE_KEY:
        description: "GitHub App Private Key used to generate a token for the repository dispatch"
        required: true

jobs:
  check-changes:
    name: Check for changes since the last tag
    runs-on: ubuntu-latest
    outputs:
      changes: ${{ steps.check-changes.outputs.changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check for changes since the last tag
        id: check-changes
        shell: bash
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "No previous tag found. Proceeding with the workflow."
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "Last tag: $LAST_TAG"
            CHANGES=$(git diff --name-only "$LAST_TAG"..HEAD)
            if [ -z "$CHANGES" ]; then
              echo "No changes detected since the last tag."
              echo "changes=false" >> $GITHUB_OUTPUT
            else
              echo "Changes detected since the last tag."
              echo "changes=true" >> $GITHUB_OUTPUT
            fi
          fi

  open-release-pr:
    name: Open a PR that prepares policy for release
    needs: check-changes
    if: needs.check-changes.outputs.changes == 'true'

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check for changes since the last tag
        id: check-changes
        shell: bash
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "No previous tag found. Proceeding with the workflow."
            echo "changes=true" >> $GITHUB_ENV
          else
            echo "Last tag: $LAST_TAG"
            CHANGES=$(git diff --name-only "$LAST_TAG"..HEAD)
            if [ -z "$CHANGES" ]; then
              echo "No changes detected since the last tag."
              echo "changes=false" >> $GITHUB_ENV
              exit 0
            else
              echo "Changes detected since the last tag."
              echo "changes=true" >> $GITHUB_ENV
            fi
          fi

      - name: Install Updatecli in the runner
        uses: updatecli/updatecli-action@4fd2c16d992120bd5355264a03ad0cddec013e1b # v2.99.0

      - uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: generate-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Restore cargo-set-version from cache
        if: hashFiles('**/Cargo.toml') != ''
        id: restore-cache
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: ~/.cargo/bin
          key: cargo-edit-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-edit-${{ runner.os }}-

      - name: Install cargo-set-version
        if: >
          hashFiles('**/Cargo.toml') != '' &&
          ! steps.restore-cache.outputs.cache-hit
        run: cargo install cargo-edit

      - name: Create values.yaml for Updatecli
        run: |
          cat <<EOF > values.yaml
          github:
            owner: "${{ github.repository_owner }}"
            repo: "${{ github.event.repository.name }}"
            branch: "main"
            git_author: "Kubewarden bot"
            git_email: "cncf-kubewarden-maintainers@lists.cncf.io"

          pr:
            labels:
              - "TRIGGER-RELEASE"
              - "kind/chore"
              - "area/release"
            reviewers:
              - "kubewarden/kubewarden-developers"
          EOF

      - name: Open PR with updatecli
        id: open-release-pr
        env:
          UPDATECLI_GITHUB_OWNER: ${{ github.repository_owner }}
          UPDATECLI_GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |-
          updatecli apply ghcr.io/kubewarden/automation/updatecli/open-release-pr:0.1.1 \
            --values $(pwd)/values.yaml
